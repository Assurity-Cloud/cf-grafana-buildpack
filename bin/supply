#!/usr/bin/env bash
set -euo pipefail

BUILD_DIR="${1}"
CACHE_DIR="${2}"
DEPS_DIR="${3}"
DEPS_IDX="${4}"

GRAFANA_VERSION="${GRAFANA_VERSION:-6.0.1}"
GRAFANA_DOWNLOAD_URL="https://dl.grafana.com/oss/release/grafana-${GRAFANA_VERSION}.linux-amd64.tar.gz"

BUILDPACK_DIR=$(dirname $(readlink -f ${BASH_SOURCE%/*}))
GRAFANA_DIR="${DEPS_DIR}/grafana"
SQLPROXY_DIR="${DEPS_DIR}/cloud_sql_proxy"

[ -f "${BUILD_DIR}/runtime.txt" ] && GRAFANA_DOWNLOAD_URL=$(cat "${BUILD_DIR}/runtime.txt")
echo "-----> Downloading Grafana: ${GRAFANA_DOWNLOAD_URL}"
wget -nv "${GRAFANA_DOWNLOAD_URL}" -O "${CACHE_DIR}/grafana.tgz" 2>&1 | sed 's/^/       /'

echo "-----> Installing Grafana"
mkdir -p "${GRAFANA_DIR}"
tar -zxf ${CACHE_DIR}/grafana.tgz -C "${GRAFANA_DIR}" --strip-components 1

echo "-----> Installing cloud sql proxy"
mkdir -p "${SQLPROXY_DIR}"
wget -nv https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O "${SQLPROXY_DIR}/cloud_sql_proxy" 2>&1 | sed 's/^/       /'
